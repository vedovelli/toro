var client_url="http://toro.ved",db_url="mongodb://127.0.0.1/toro",Candidato,Usuario,usuario,Comentario,mongoose=require("mongoose").connect(db_url),db=mongoose.connection;db.on("error",console.error.bind(console,"connection error:")),db.once("open",function o(){var o=mongoose.Schema({nome:String,sobrenome:String,slug:String,votos:{favor:Number,contra:Number}}),e=mongoose.Schema({id:Number,displayName:String,gender:String,provider:String,hometown:String,location:String,avatar:String}),a=mongoose.Schema({usuario:Number,candidato:String,comentario:String,data:Date});Candidato=mongoose.model("Candidato",o),Usuario=mongoose.model("Usuario",e),Comentario=mongoose.model("Comentario",a)});var passport=require("passport"),FacebookStrategy=require("passport-facebook").Strategy;passport.use(new FacebookStrategy({clientID:"1433705530208473",clientSecret:"77dbcee96747a99e24a78806dcebca2b",callbackURL:"http://toro.ved:4730/auth/facebook/callback"},function(o,e,a,n){Usuario.findOne({id:a.id},function(o,e){return o?n(o):(e?(e.id=a.id,e.displayName=a.displayName,e.gender=a.gender,e.provider=a.provider,e.hometown=a._json.hometown.name,e.location=a._json.location.name,e.avatar="https://graph.facebook.com/"+a.username+"/picture"):e=new Usuario({id:a.id,displayName:a.displayName,gender:a.gender,provider:a.provider,hometown:a._json.hometown.name,location:a._json.location.name,avatar:"https://graph.facebook.com/"+a.username+"/picture"}),e.save(),passport.serializeUser(function(o,e){e(null,o.id)}),passport.deserializeUser(function(o,e){Usuario.find({id:o},function(o,a){e(o,a)})}),n(null,e))})}));var express=require("express"),app=express(),MongoStore=require("connect-mongo")(express);app.listen(4730),app.configure(function(){app.use(express.static("public")),app.use(express.cookieParser()),app.use(express.bodyParser()),app.use(express.session({secret:"tororoto"})),app.use(passport.initialize()),app.use(passport.session()),app.use(app.router)}),app.get("/auth/facebook",passport.authenticate("facebook")),app.get("/auth/facebook/callback",passport.authenticate("facebook",{successRedirect:"/auth/facebook/ok",failureRedirect:"/login"})),app.get("/auth/facebook/ok",function(o,e){usuario=o.user,e.redirect(client_url)}),app.get("/login",function(o,e){e.type("text/plain"),e.send("login route")}),app.get("/ved",function(o,e){}),app.get("/",function(o,e){e.type("text/plain"),e.send("Toro")}),app.get("/comentarios/:candidato",function(o,e){Comentario.find({candidato:o.params.candidato}).sort("-data").exec(function(o,a){e.setHeader("Access-Control-Allow-Origin","*"),e.json(a)})}),app.post("/comentario",function(o,e){var a=new Comentario({usuario:o.body.usuario,candidato:o.body.candidato,comentario:o.body.comentario,data:new Date});a.save(),e.setHeader("Access-Control-Allow-Origin","*"),e.json(a)}),app.get("/voto/:candidato/:voto",function(o,e){var a;e.setHeader("Access-Control-Allow-Origin","*"),Candidato.find({_id:o.params.candidato},function(n,t){t?("favor"===o.params.voto?t[0].votos.favor++:"contra"===o.params.voto&&t[0].votos.contra++,t[0].save(),a={response:!0,message:"voto salvo com sucesso."}):a={response:!1,message:"candidato n√£o localizado."},e.json(a)})}),app.get("/candidatos",function(o,e){var a=Candidato.find(function(o,a){e.setHeader("Access-Control-Allow-Origin","*"),e.json(a)})}),app.get("/candidato/:slug",function(o,e){Candidato.find({slug:o.params.slug},function(o,a){e.setHeader("Access-Control-Allow-Origin","*"),e.json(a[0])})}),app.get("/usuario",function(o,e){e.setHeader("Access-Control-Allow-Origin","*"),e.json(usuario)});